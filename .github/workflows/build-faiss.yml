name: Build FAISS for Bleve

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  FAISS_REPO: https://github.com/blevesearch/faiss.git
  FAISS_BRANCH: bleve

jobs:
  build:
    name: Build FAISS - ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: darwin-arm64
            runner: macos-14
            goos: darwin
            goarch: arm64
            os_name: darwin
            arch_name: arm64
            opt_level: generic
            cmake_extra: ""
            lib_ext: a
            shared_ext: dylib
            homebrew_prefix: /opt/homebrew

          - target: darwin-amd64
            runner: macos-15-intel
            goos: darwin
            goarch: amd64
            os_name: darwin
            arch_name: amd64
            opt_level: avx2
            cmake_extra: ""
            lib_ext: a
            shared_ext: dylib
            homebrew_prefix: /usr/local

          - target: linux-amd64
            runner: ubuntu-latest
            goos: linux
            goarch: amd64
            os_name: linux
            arch_name: amd64
            opt_level: avx2
            cmake_extra: ""
            lib_ext: a
            shared_ext: so
            homebrew_prefix: ""

          - target: linux-arm64
            runner: ubuntu-22.04-arm64
            goos: linux
            goarch: arm64
            os_name: linux
            arch_name: arm64
            opt_level: generic
            cmake_extra: ""
            lib_ext: a
            shared_ext: so
            homebrew_prefix: ""

          - target: windows-amd64
            runner: windows-latest
            goos: windows
            goarch: amd64
            os_name: windows
            arch_name: amd64
            opt_level: avx2
            cmake_extra: "-DBLA_STATIC=ON -DBLA_VENDOR=OpenBLAS"
            lib_ext: lib
            shared_ext: dll
            homebrew_prefix: ""

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone blevesearch/faiss
        run: |
          git clone --depth 1 --branch ${{ env.FAISS_BRANCH }} ${{ env.FAISS_REPO }} faiss-src

      # ── Install dependencies ──

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            libopenblas-dev \
            libomp-dev \
            pkg-config

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake openblas libomp

      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install vcpkg and deps (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          set VCPKG_ROOT=C:\vcpkg
          if not exist "%VCPKG_ROOT%" (
            git clone --depth 1 https://github.com/microsoft/vcpkg "%VCPKG_ROOT%"
          )
          call "%VCPKG_ROOT%\bootstrap-vcpkg.bat"
          "%VCPKG_ROOT%\vcpkg.exe" install "openblas[lapack]:x64-windows-static" "lapack-reference:x64-windows-static"
          "%VCPKG_ROOT%\vcpkg.exe" list
          dir "%VCPKG_ROOT%\installed\x64-windows-static\lib"

      # ── Build FAISS ──

      - name: Build FAISS (macOS)
        if: runner.os == 'macOS'
        working-directory: faiss-src
        env:
          OpenMP_ROOT: ${{ matrix.homebrew_prefix }}/opt/libomp
          LDFLAGS: "-L${{ matrix.homebrew_prefix }}/opt/libomp/lib"
          CPPFLAGS: "-I${{ matrix.homebrew_prefix }}/opt/libomp/include"
          CXXFLAGS: "-Xpreprocessor -fopenmp -I${{ matrix.homebrew_prefix }}/opt/libomp/include"
        run: |
          cmake -B build \
            -DFAISS_ENABLE_GPU=OFF \
            -DFAISS_ENABLE_PYTHON=OFF \
            -DFAISS_ENABLE_C_API=ON \
            -DFAISS_ENABLE_EXTRAS=OFF \
            -DFAISS_ENABLE_MKL=OFF \
            -DFAISS_OPT_LEVEL=${{ matrix.opt_level }} \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TESTING=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/faiss-install \
            -DCMAKE_PREFIX_PATH="${{ matrix.homebrew_prefix }}/opt/libomp;${{ matrix.homebrew_prefix }}/opt/openblas" \
            -DOpenMP_ROOT=${{ matrix.homebrew_prefix }}/opt/libomp \
            -DOpenMP_C_FLAGS="-Xpreprocessor -fopenmp" \
            -DOpenMP_CXX_FLAGS="-Xpreprocessor -fopenmp" \
            -DOpenMP_C_LIB_NAMES="omp" \
            -DOpenMP_CXX_LIB_NAMES="omp" \
            -DOpenMP_omp_LIBRARY=${{ matrix.homebrew_prefix }}/opt/libomp/lib/libomp.dylib \
            ${{ matrix.cmake_extra }}

          cmake --build build --config Release -j $(sysctl -n hw.ncpu)
          cmake --install build --config Release

      - name: Build FAISS (Linux)
        if: runner.os == 'Linux'
        working-directory: faiss-src
        run: |
          cmake -B build \
            -DFAISS_ENABLE_GPU=OFF \
            -DFAISS_ENABLE_PYTHON=OFF \
            -DFAISS_ENABLE_C_API=ON \
            -DFAISS_ENABLE_EXTRAS=OFF \
            -DFAISS_ENABLE_MKL=OFF \
            -DFAISS_OPT_LEVEL=${{ matrix.opt_level }} \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_TESTING=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/faiss-install \
            ${{ matrix.cmake_extra }}

          cmake --build build --config Release -j $(nproc)
          cmake --install build --config Release

      - name: Build FAISS (Windows)
        if: runner.os == 'Windows'
        working-directory: faiss-src
        shell: cmd
        run: |
          set VCPKG_ROOT=C:\vcpkg
          set LAPACK_LIBS=%VCPKG_ROOT%\installed\x64-windows-static\lib\openblas.lib;%VCPKG_ROOT%\installed\x64-windows-static\lib\lapack.lib

          cmake -B build ^
            -DFAISS_ENABLE_GPU=OFF ^
            -DFAISS_ENABLE_PYTHON=OFF ^
            -DFAISS_ENABLE_C_API=ON ^
            -DFAISS_ENABLE_EXTRAS=OFF ^
            -DFAISS_ENABLE_MKL=OFF ^
            -DFAISS_OPT_LEVEL=${{ matrix.opt_level }} ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DBUILD_TESTING=OFF ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}\faiss-install ^
            -DCMAKE_TOOLCHAIN_FILE=%VCPKG_ROOT%\scripts\buildsystems\vcpkg.cmake ^
            -DVCPKG_TARGET_TRIPLET=x64-windows-static ^
            -DLAPACK_LIBRARIES="%LAPACK_LIBS%" ^
            ${{ matrix.cmake_extra }}

          cmake --build build --config Release -j %NUMBER_OF_PROCESSORS%
          cmake --install build --config Release

      # ── Verify build output ──

      - name: Verify build output (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "=== Installed libraries ==="
          find ${{ github.workspace }}/faiss-install -name "*.a" -o -name "*.so" -o -name "*.dylib" | head -50
          echo ""
          echo "=== Installed headers ==="
          find ${{ github.workspace }}/faiss-install -name "*.h" | head -50

      - name: Verify build output (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== Installed libraries ==="
          Get-ChildItem -Recurse "${{ github.workspace }}\faiss-install" -Include *.lib,*.dll | ForEach-Object { $_.FullName }
          Write-Host ""
          Write-Host "=== Installed headers ==="
          Get-ChildItem -Recurse "${{ github.workspace }}\faiss-install" -Include *.h | ForEach-Object { $_.FullName }

      # ── Package artifacts ──

      - name: Package artifacts (Unix)
        if: runner.os != 'Windows'
        run: |
          cd ${{ github.workspace }}/faiss-install
          tar -czf ${{ github.workspace }}/faiss-${{ matrix.target }}.tar.gz .

      - name: Package artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "${{ github.workspace }}\faiss-install\*" `
            -DestinationPath "${{ github.workspace }}\faiss-${{ matrix.target }}.zip"

      # ── Upload artifacts ──

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: faiss-${{ matrix.target }}
          path: |
            faiss-*.tar.gz
            faiss-*.zip
          retention-days: 30

  # ════════════════════════════════════════════
  #  Verify: CGO linking test with go-faiss
  # ════════════════════════════════════════════
  verify:
    name: Verify go-faiss link - ${{ matrix.target }}
    needs: build
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: darwin-arm64
            runner: macos-14
          - target: darwin-amd64
            runner: macos-15-intel
          - target: linux-amd64
            runner: ubuntu-latest
          - target: linux-arm64
            runner: ubuntu-22.04-arm64
    steps:
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Download FAISS artifact
        uses: actions/download-artifact@v4
        with:
          name: faiss-${{ matrix.target }}

      - name: Extract FAISS
        run: |
          mkdir -p faiss-install
          tar -xzf faiss-${{ matrix.target }}.tar.gz -C faiss-install

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libopenblas-dev libomp-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install openblas libomp

      - name: Test go-faiss CGO linking
        env:
          CGO_ENABLED: "1"
          CGO_CFLAGS: "-I${{ github.workspace }}/faiss-install/include"
          CGO_LDFLAGS: "-L${{ github.workspace }}/faiss-install/lib -lfaiss_c -lfaiss -lstdc++ -lm -lomp"
        run: |
          mkdir -p test-link && cd test-link
          go mod init test-link
          go get github.com/blevesearch/go-faiss@latest
          cat > main.go << 'EOF'
          package main

          import (
              "fmt"
              faiss "github.com/blevesearch/go-faiss"
          )

          func main() {
              idx, err := faiss.IndexFactory(128, "Flat", faiss.MetricL2)
              if err != nil {
                  panic(err)
              }
              defer idx.Delete()
              fmt.Println("FAISS index created successfully!")
          }
          EOF
          go build -v -o test-faiss .
          echo "CGO linking succeeded for ${{ matrix.target }}"

  # ════════════════════════════════════════════
  #  Release: Create GitHub Release on v* tags
  # ════════════════════════════════════════════
  release:
    name: Create Release
    needs: [build, verify]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
